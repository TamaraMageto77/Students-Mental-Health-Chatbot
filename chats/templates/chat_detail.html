{% extends 'chat_base.html' %}

{% block content %}
  <div class="main-content">
    <div class="chat-container" id="chat-container">
      <!-- Example received message -->
      <div class="message received">
        <div class="message-avatar">
          <i class="fas fa-robot"></i>
        </div>
        <div>
          <div class="message-content">Hello! How can I help you today?</div>
          <div class="message-time">11:30 AM</div>
        </div>
      </div>

      <!-- Example sent message -->
      <div class="message sent">
        <div class="message-avatar">
          <i class="fas fa-user"></i>
        </div>
        <div>
          <div class="message-content">I need help with my project documentation.</div>
          <div class="message-time">11:31 AM</div>
        </div>
      </div>
    </div>

    <div class="input-container">
      <div class="message-input-group">
        <input type="text" class="message-input" id="message-input" placeholder="Type your message..." />
        <button class="send-button" id="send-button"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <script>
    function sendMessage() {
      var messageInput = document.getElementById('message-input');
      var message = messageInput.value;

      if (message.trim() === '') {
        return; // Don't send empty messages
      }

      var xhr = new XMLHttpRequest();
      xhr.open('POST', '{% url "message_create" chat_id=chat.id %}', true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');

      xhr.onreadystatechange = function() {
        if (xhr.readyState === XMLHttpRequest.DONE) {
          if (xhr.status === 200) {
            // Log response to the console
            console.log("Response:", xhr.responseText);
            var response = JSON.parse(xhr.responseText);
            var chatContainer = document.getElementById('chat-container');

            var messageDiv = document.createElement('div');
            messageDiv.classList.add('message', 'sent');

            var avatarDiv = document.createElement('div');
            avatarDiv.classList.add('message-avatar');
            avatarDiv.innerHTML = '<i class="fas fa-user"></i>';

            var contentDiv = document.createElement('div');
            var messageContentDiv = document.createElement('div');
            messageContentDiv.classList.add('message-content');
            messageContentDiv.textContent = response.message;

            var messageTimeDiv = document.createElement('div');
            messageTimeDiv.classList.add('message-time');
            messageTimeDiv.textContent = response.time;

            contentDiv.appendChild(messageContentDiv);
            contentDiv.appendChild(messageTimeDiv);

            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);

            chatContainer.appendChild(messageDiv);
            messageInput.value = ''; // Clear input after sending
          } else {
            // Log error to the console
            console.error("Error sending message:", xhr.status, xhr.statusText);
          }
        }
      };

      var data = JSON.stringify({ 'message': message });
      xhr.send(data);
    }

    document.getElementById('send-button').addEventListener('click', sendMessage);

    document.getElementById('message-input').addEventListener('keypress', function(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    });
  </script>
{% endblock %}
